# scoreboard_definitions.lua - Типы итерации и валидации

## Назначение

Файл определяет типы итерации (способ обновления значений) и валидации (способ определения лучших/худших значений) для строк статистики.

## Типы итерации (iteration_types)

Итерация определяет, как обновляется значение строки при получении нового значения.

### Структура типа итерации

Каждый тип итерации - это объект с функцией `value`, которая принимает:
- `add_value` - новое значение для добавления
- `old_value` - текущее значение

И возвращает:
- Новое значение
- Прирост очков (score increment)

---

### `ADD` - Добавление

**Назначение:** Простое добавление значения к текущему.

**Функция:**
```lua
value = function(add_value, old_value)
    return old_value + add_value, add_value
end
```

**Пример:**
- Текущее значение: 10
- Новое значение: 5
- Результат: 15 (новое значение), 5 (прирост очков)

**Использование:** Для счетчиков (убийства, поднятые предметы, использованные предметы).

---

### `DIFF` - Разница

**Назначение:** Вычисляет разницу между новым и старым значением.

**Функция:**
```lua
value = function(new_value, old_value)
    return new_value, math.max(new_value - old_value, 0)
end
```

**Пример:**
- Текущее значение: 100
- Новое значение: 80
- Результат: 80 (новое значение), 0 (прирост очков, так как значение уменьшилось)

**Пример 2:**
- Текущее значение: 100
- Новое значение: 120
- Результат: 120 (новое значение), 20 (прирост очков)

**Использование:** Для отслеживания изменений значений (полученный урон, здоровье).

---

### `ADD_IF_ZERO` - Добавление только если значение 0

**Назначение:** Добавляет значение только если текущее значение равно 0.

**Функция:**
```lua
value = function(add_value, old_value)
    if old_value == 0 then
        return old_value + add_value, add_value
    else
        return old_value, 0
    end
end
```

**Пример:**
- Текущее значение: 0
- Новое значение: 1
- Результат: 1 (новое значение), 1 (прирост очков)

**Пример 2:**
- Текущее значение: 5
- Новое значение: 1
- Результат: 5 (значение не изменилось), 0 (прирост очков)

**Использование:** Для событий, которые должны учитываться только один раз.

---

## Типы валидации (validation_types)

Валидация определяет, как вычисляются очки и как определяется лучший/худший игрок.

### Структура типа валидации

Каждый тип валидации - это объект с функциями:
- `is_best(data, account_id)` - Проверяет, является ли игрок лучшим
- `is_worst(data, account_id)` - Проверяет, является ли игрок худшим
- `score(data, account_id)` - Вычисляет очки для игрока

**Параметры:**
- `data` - Таблица с данными всех игроков: `{[account_id] = {score = value, ...}}`
- `account_id` - Идентификатор аккаунта игрока

---

### Базовые функции валидации

#### `base_validation_types.highest`

**Назначение:** Находит игрока с наибольшим значением.

**Функция:**
```lua
function(data, account_id)
    local best = account_id
    if data[account_id] then
        local score = data[account_id].score or 0
        for name, values in pairs(data) do
            if values.score > score then
                best = name
                score = values.score
            end
        end
    end
    return best == account_id, best
end
```

**Возвращает:**
- `true/false` - Является ли игрок лучшим
- `best` - Идентификатор лучшего игрока

---

#### `base_validation_types.lowest`

**Назначение:** Находит игрока с наименьшим значением.

**Функция:** Аналогично `highest`, но ищет минимальное значение.

---

### `ASC` - Восходящая валидация (больше = лучше)

**Назначение:** Используется для статистики, где большее значение лучше.

**Функции:**
- `is_best`: Использует `base_validation_types.highest`
- `is_worst`: Использует `base_validation_types.lowest`
- `score`: Возвращает значение `score` игрока как есть

**Пример использования:**
- Убийства врагов
- Нанесенный урон
- Поднятые предметы
- Помощь союзникам

---

### `DESC` - Нисходящая валидация (меньше = лучше)

**Назначение:** Используется для статистики, где меньшее значение лучше.

**Функции:**
- `is_best`: Использует `base_validation_types.lowest` (меньше = лучше)
- `is_worst`: Использует `base_validation_types.highest` (больше = хуже)
- `score`: Вычисляет очки инвертированно:
  ```lua
  function(self, data, account_id)
      local _, worst = self.is_worst(data, account_id)
      local worst_value = data[worst].score or 0
      local _, best = self.is_best(data, account_id)
      local best_value = data[best].score or 0
      local score = data[account_id].score or 0
      return (best_value - score) + worst_value
  end
  ```

**Логика подсчета очков:**
- Находит худшее значение (наибольшее)
- Находит лучшее значение (наименьшее)
- Вычисляет: `(лучшее - текущее) + худшее`
- Это означает: чем меньше значение игрока, тем больше очков

**Пример использования:**
- Полученный урон
- Потраченные впустую боеприпасы
- Избыточный урон

**Пример расчета:**
- Игрок A: 100 урона → очки: (50 - 100) + 200 = 150
- Игрок B: 50 урона → очки: (50 - 50) + 200 = 200 (лучший)
- Игрок C: 200 урона → очки: (50 - 200) + 200 = 50 (худший)

---

### `BLANK` - Пустая валидация

**Назначение:** Базовая валидация без специальной логики.

**Функции:**
- `is_best`: Использует `base_validation_types.highest`
- `is_worst`: Использует `base_validation_types.lowest`
- `score`: Возвращает значение `score` игрока как есть

**Использование:** Для строк, которые не требуют специальной логики валидации.

---

## Использование в строках статистики

### Пример определения строки с типом итерации и валидации

```lua
{
    name = "damage_dealt",
    text = "row_damage_dealt",
    validation = "ASC",      -- Больше урона = лучше
    iteration = "ADD",       -- Простое добавление урона
    group = "offense",
}
```

### Пример с DESC валидацией

```lua
{
    name = "damage_taken",
    text = "row_damage_taken",
    validation = "DESC",     -- Меньше урона = лучше
    iteration = "DIFF",      -- Отслеживание изменений здоровья
    group = "defense",
}
```

---

## Вычисление очков для строк с summary

Когда строка имеет поле `summary` (суммирует значения дочерних строк), очки вычисляются следующим образом:

1. Собираются все дочерние строки из `summary`
2. Для каждой дочерней строки вычисляются очки через `validation:score()`
3. Все очки суммируются

**Пример:**
- Строка `damage_dealt` имеет `summary = ["actual_damage_dealt", "overkill_damage_dealt"]`
- Очки = очки(`actual_damage_dealt`) + очки(`overkill_damage_dealt`)

---

## Нормализация значений

Некоторые строки имеют флаг `normalize = true`. Это означает, что значения нормализуются к среднему значению 100 перед вычислением очков.

**Процесс нормализации:**
1. Вычисляется среднее значение всех игроков
2. Если среднее > 100: все значения умножаются на 0.9 до тех пор, пока среднее не станет <= 100
3. Если среднее < 100: все значения умножаются на 1.1 до тех пор, пока среднее не станет >= 100

**Использование:** Для статистики, где значения могут сильно различаться между игроками (когерентность, время переноски).

---

## Определение лучшего/худшего игрока

После обновления значений для каждой строки вызываются функции `is_best` и `is_worst`, которые устанавливают флаги в данных игрока:

```lua
row_data.is_best = validation.is_best(data, account_id)
row_data.is_worst = validation.is_worst(data, account_id)
```

Эти флаги используются в UI для выделения лучших/худших значений цветом.

---

## Зависимости

Нет внешних зависимостей. Файл является самодостаточным определением типов.

---

## Примеры использования

### Создание собственного типа итерации

```lua
local custom_iteration = {
    value = function(add_value, old_value)
        -- Кастомная логика
        return old_value + add_value * 2, add_value * 2
    end
}
```

### Создание собственного типа валидации

```lua
local custom_validation = {
    is_best = function(data, account_id)
        -- Логика определения лучшего
    end,
    is_worst = function(data, account_id)
        -- Логика определения худшего
    end,
    score = function(self, data, account_id)
        -- Логика вычисления очков
    end
}
```

### Использование в строке

```lua
{
    name = "my_stat",
    validation = "ASC",
    iteration = "ADD",
    -- или
    validation = custom_validation,
    iteration = custom_iteration,
}
```
