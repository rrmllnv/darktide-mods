# scoreboard.lua - Главный файл мода

## Назначение

Главный файл мода, который инициализирует все компоненты, регистрирует хуки, управляет жизненным циклом мода и предоставляет API для работы со scoreboard.

## Структура файла

### Импорты и инициализация

```lua
local mod = get_mod("scoreboard")
mod.name = "scoreboard"

local DMF = get_mod("DMF")
local _os = DMF:persistent_table("_os")
```

**Переменные:**
- `mod` - объект мода, полученный через `get_mod()`
- `DMF` - ссылка на мод DMF (Darktide Mod Framework)
- `_os` - персистентная таблица для работы с операционной системой

### Основные функции жизненного цикла

#### `mod.on_game_state_changed(status, state_name)`

**Назначение:** Вызывается при смене игрового состояния.

**Параметры:**
- `status` - статус перехода ("enter" или "exit")
- `state_name` - имя состояния (например, "StateGameplay")

**Что делает:**
- При входе в состояние "StateGameplay" очищает все данные строк статистики через `mod:clear()`

**Использование:** Автоматически вызывается системой модов при смене состояний игры.

---

#### `mod.on_all_mods_loaded()`

**Назначение:** Вызывается после загрузки всех модов.

**Что делает:**
1. Загружает необходимые пакеты UI:
   - `packages/ui/views/end_player_view/end_player_view`
   - `packages/ui/views/store_item_detail_view/store_item_detail_view`
2. Собирает строки статистики из всех модов через `mod:collect_scoreboard_rows()`

**Использование:** Обеспечивает, что все моды загружены перед сбором строк статистики.

---

#### `mod.reload_mods()`

**Назначение:** Вызывается при перезагрузке модов.

**Что делает:**
- Пересобирает строки статистики из всех модов

**Использование:** Позволяет обновить список строк без перезапуска игры.

---

#### `mod.update(main_dt)`

**Назначение:** Вызывается каждый кадр для обновления данных.

**Параметры:**
- `main_dt` - время, прошедшее с последнего кадра (delta time)

**Что делает:**
1. Обновляет статистику когерентности (близость к союзникам)
2. Обновляет статистику переноски предметов

**Использование:** Непрерывно отслеживает динамические показатели.

---

#### `mod.on_setting_changed(setting_id)`

**Назначение:** Вызывается при изменении настройки мода.

**Параметры:**
- `setting_id` - идентификатор измененной настройки

**Что делает:**
1. Обновляет опцию в UI через `mod.update_option(setting_id)`
2. Обновляет флаг `tactical_overview` для отображения в HUD

**Использование:** Реагирует на изменения настроек пользователя.

---

### Функции работы с опциями

#### `mod.find_option_in_data(obj, setting_id)`

**Назначение:** Рекурсивно ищет опцию в структуре данных настроек.

**Параметры:**
- `obj` - объект с опциями (массив или таблица)
- `setting_id` - идентификатор настройки для поиска

**Возвращает:** Объект опции или `nil`, если не найдена

**Что делает:**
- Проходит по всем опциям в `obj`
- Если опция имеет `sub_widgets`, рекурсивно ищет в них
- Возвращает первую найденную опцию с совпадающим `setting_id`

**Использование:** Используется для поиска опций в иерархической структуре настроек.

---

#### `mod.fetch_option_from_data(setting_id)`

**Назначение:** Получает опцию из структуры данных настроек.

**Параметры:**
- `setting_id` - идентификатор настройки

**Возвращает:** Объект опции из `ScoreboardData.options.widgets`

**Что делает:**
- Использует `find_option_in_data` для поиска в `ScoreboardData.options.widgets`

**Использование:** Получение метаданных опции (тип, значения по умолчанию и т.д.).

---

#### `mod.fetch_option_from_view(setting_id)`

**Назначение:** Получает виджет опции из активного UI view настроек.

**Параметры:**
- `setting_id` - идентификатор настройки

**Возвращает:** Виджет опции из UI или `nil`

**Что делает:**
1. Получает экземпляр view `dmf_options_view`
2. Ищет виджет по локализованному имени настройки
3. Возвращает найденный виджет

**Использование:** Получение UI виджета для изменения его свойств (например, disabled).

---

#### `mod.update_option(setting_id)`

**Назначение:** Обновляет состояние опции в UI при изменении настройки.

**Параметры:**
- `setting_id` - идентификатор измененной настройки

**Что делает:**
1. Получает данные опции из `ScoreboardData`
2. Если опция типа "checkbox":
   - Получает текущее значение настройки
   - Если у опции есть `sub_widgets`, обновляет их состояние `disabled` в зависимости от значения родительской опции

**Использование:** Синхронизирует UI с состоянием настроек (например, скрывает дочерние опции, если родительская выключена).

---

#### `mod.update_options()`

**Назначение:** Обновляет все опции в UI.

**Что делает:**
- Проходит по всем опциям в `ScoreboardData.options.widgets`
- Вызывает `update_option` для каждой опции

**Использование:** Вызывается при загрузке view настроек для синхронизации всех опций.

---

### Функции управления view

#### `mod.open_scoreboard()`

**Назначение:** Открывает или закрывает scoreboard view.

**Что делает:**
1. Проверяет, открыт ли scoreboard через `mod:scoreboard_opened()`
2. Если открыт - закрывает через `mod:close_scoreboard_view()`
3. Если закрыт и включен `dev_mode` - открывает через `mod:show_scoreboard_view()`

**Использование:** Привязывается к горячей клавише для открытия/закрытия scoreboard в режиме разработки.

---

#### `mod.show_scoreboard_view(context)`

**Назначение:** Открывает scoreboard view.

**Параметры:**
- `context` - контекст для передачи в view (опционально)

**Что делает:**
1. Закрывает текущий scoreboard view, если открыт
2. Открывает новый view через `ui_manager:open_view()`

**Использование:** Программное открытие scoreboard view.

---

#### `mod.scoreboard_opened()`

**Назначение:** Проверяет, открыт ли scoreboard view.

**Возвращает:** `true`, если view активен и не закрывается, иначе `false`

**Использование:** Проверка состояния view перед операциями.

---

#### `mod.close_scoreboard_view()`

**Назначение:** Закрывает scoreboard view.

**Что делает:**
- Проверяет, активен ли view
- Если активен, закрывает его через `ui_manager:close_view()`

**Использование:** Программное закрытие scoreboard view.

---

### Функции инициализации

#### `mod.initialize()`

**Назначение:** Инициализирует основные компоненты мода.

**Что делает:**
1. Загружает определения через `io_dofile("scoreboard_definitions")`
2. Сохраняет ссылки на менеджеры:
   - `ui_manager` - менеджер UI
   - `player_manager` - менеджер игроков
   - `package_manager` - менеджер пакетов
3. Устанавливает флаг `initialized = true`

**Использование:** Вызывается один раз при загрузке мода для инициализации.

---

#### `mod.set_mission_name(mission_name)`

**Назначение:** Сохраняет название текущей миссии.

**Параметры:**
- `mission_name` - название миссии

**Использование:** Сохранение информации о миссии для истории.

---

#### `mod.set_mission_circumstance(mission_circumstance)`

**Назначение:** Сохраняет обстоятельства миссии.

**Параметры:**
- `mission_circumstance` - название обстоятельства

**Использование:** Сохранение информации о миссии для истории.

---

#### `mod.set_mission_challenge(mission_challenge)`

**Назначение:** Сохраняет вызов миссии.

**Параметры:**
- `mission_challenge` - название вызова

**Использование:** Сохранение информации о миссии для истории.

---

#### `mod.set_victory_defeat(victory_defeat)`

**Назначение:** Сохраняет результат миссии (победа/поражение).

**Параметры:**
- `victory_defeat` - результат миссии

**Использование:** Сохранение информации о миссии для истории.

---

#### `mod.initialize_timer()`

**Назначение:** Инициализирует таймер миссии.

**Что делает:**
- Сохраняет текущее время через `_os.time()` в `mod.timer`

**Использование:** Отслеживание длительности миссии.

---

### Функции работы с пакетами

#### `mod.load_package(package_name)`

**Назначение:** Загружает UI пакет, если он еще не загружен.

**Параметры:**
- `package_name` - имя пакета для загрузки

**Возвращает:** Результат загрузки пакета

**Что делает:**
1. Проверяет, не загружается ли пакет уже
2. Проверяет, не загружен ли пакет уже
3. Если нет - загружает через `package_manager:load()`

**Использование:** Загрузка необходимых UI ресурсов.

---

#### `mod.release_package(package_id)`

**Назначение:** Выгружает UI пакет.

**Параметры:**
- `package_id` - идентификатор пакета для выгрузки

**Использование:** Освобождение памяти после использования пакета.

---

### Функции регистрации view

#### `mod.register_scoreboard_view()`

**Назначение:** Регистрирует основной scoreboard view в системе UI.

**Что делает:**
1. Добавляет пути для require файлов view
2. Регистрирует view через `register_view()` с настройками:
   - `view_name = "scoreboard_view"`
   - `class = "ScoreboardView"`
   - `disable_game_world = false` - не блокирует игровой мир
   - `load_always = true` - всегда загружен
   - `load_in_hub = true` - загружается в хабе
   - `state_bound = false` - не привязан к состоянию
3. Загружает файл view через `io_dofile()`

**Использование:** Регистрация основного view для отображения scoreboard.

---

#### `mod.register_scoreboard_history_view()`

**Назначение:** Регистрирует view истории scoreboard.

**Что делает:**
- Аналогично `register_scoreboard_view()`, но для view истории
- `view_name = "scoreboard_history_view"`
- `class = "ScoreboardHistoryView"`
- `state_bound = true` - привязан к состоянию

**Использование:** Регистрация view для просмотра истории результатов.

---

### Функции работы с данными

#### `mod.clear()`

**Назначение:** Очищает все данные строк статистики.

**Что делает:**
- Проходит по всем зарегистрированным строкам
- Очищает таблицу `data` каждой строки или создает новую пустую таблицу

**Использование:** Вызывается при начале новой миссии для сброса статистики.

---

#### `mod.update_stat(name, account_id, value)`

**Назначение:** Обновляет значение статистики для игрока.

**Параметры:**
- `name` - имя строки статистики
- `account_id` - идентификатор аккаунта игрока
- `value` - новое значение

**Что делает:**
- Вызывает `mod:update_row_value()` для обновления значения

**Использование:** Универсальная функция для обновления любой статистики.

---

#### `mod.shorten_value(value, decimals)`

**Назначение:** Сокращает большие числа для отображения (например, 1000 -> 1.0K).

**Параметры:**
- `value` - числовое значение
- `decimals` - количество знаков после запятой (по умолчанию 0)

**Возвращает:** Строка с сокращенным значением

**Что делает:**
- Если значение >= 1000, форматирует как "X.XK"
- Иначе форматирует с указанным количеством знаков после запятой

**Использование:** Улучшение читаемости больших чисел в UI.

---

#### `mod.shorten_time(time, decimals)`

**Назначение:** Сокращает время для отображения (например, 60 секунд -> 1.0m).

**Параметры:**
- `time` - время в секундах
- `decimals` - количество знаков после запятой (по умолчанию 0)

**Возвращает:** Строка с сокращенным временем

**Что делает:**
- Если время >= 60 секунд, форматирует как "X.Xm" (минуты)
- Иначе форматирует как "X.Xs" (секунды)

**Использование:** Улучшение читаемости времени в UI.

---

### Вспомогательные функции

#### `mod.me()`

**Назначение:** Получает идентификатор аккаунта локального игрока.

**Возвращает:** `account_id` локального игрока

**Использование:** Определение, является ли игрок локальным.

---

#### `mod.is_me(account_id)`

**Назначение:** Проверяет, является ли игрок локальным.

**Параметры:**
- `account_id` - идентификатор аккаунта для проверки

**Возвращает:** `true`, если это локальный игрок, иначе `false`

**Использование:** Выделение локального игрока в UI.

---

#### `mod.is_numeric(x)`

**Назначение:** Проверяет, является ли значение числом.

**Параметры:**
- `x` - значение для проверки

**Возвращает:** `true`, если значение можно преобразовать в число, иначе `false`

**Использование:** Валидация данных перед обработкой.

---

### Хуки игровых событий

#### Хук `StateGameplay.on_enter`

**Назначение:** Отслеживает начало игрового процесса.

**Что делает:**
1. Сохраняет название миссии из `params.mission_name`
2. Сохраняет обстоятельства из `params.mechanism_data.circumstance_name`
3. Сохраняет вызов из `params.mechanism_data.challenge`
4. Инициализирует таймер миссии

**Использование:** Автоматическое сохранение информации о миссии при старте.

---

#### Хук `GameModeManager._set_end_conditions_met`

**Назначение:** Отслеживает завершение миссии.

**Что делает:**
- Сохраняет результат миссии (победа/поражение) из `outcome`

**Использование:** Автоматическое сохранение результата миссии.

---

#### Хук `EndView.on_enter`

**Назначение:** Открывает scoreboard при показе экрана окончания миссии.

**Что делает:**
- Открывает scoreboard view с контекстом `{end_view = true}`

**Использование:** Автоматическое отображение результатов в конце миссии.

---

#### Хук `EndView.on_exit`

**Назначение:** Закрывает scoreboard при закрытии экрана окончания миссии.

**Что делает:**
- Закрывает scoreboard view

**Использование:** Очистка при выходе из экрана результатов.

---

#### Хук `EndPlayerView.on_enter`

**Назначение:** Сдвигает scoreboard при показе карточек игроков.

**Что делает:**
- Сдвигает scoreboard на 300 пикселей вверх через `view:move_scoreboard(0, -300)`

**Использование:** Освобождение места для карточек игроков.

---

#### Хук `EndPlayerView.on_exit`

**Назначение:** Возвращает scoreboard на место при закрытии карточек игроков.

**Что делает:**
- Сдвигает scoreboard на 300 пикселей влево через `view:move_scoreboard(-300, 0)`

**Использование:** Восстановление позиции scoreboard.

---

#### Хук `BaseView._on_view_load_complete`

**Назначение:** Обновляет опции при загрузке view настроек.

**Что делает:**
- Если загружен `dmf_options_view`, обновляет все опции через `mod.update_options()`

**Использование:** Синхронизация UI опций при открытии настроек.

---

### Инициализация компонентов

В конце файла происходит инициализация всех компонентов:

```lua
mod:initialize()
mod:register_scoreboard_view()
mod:register_scoreboard_history_view()
mod:io_dofile("scoreboard_rows")
mod:io_dofile("scoreboard_history")
mod:io_dofile("scoreboard_default_plugins")
mod:io_dofile("scoreboard_hud")
```

**Порядок важен:**
1. Инициализация основных компонентов
2. Регистрация view
3. Загрузка модулей строк, истории, плагинов и HUD

---

## Переменные модуля

### `mod.registered_scoreboard_rows`
**Тип:** Таблица  
**Назначение:** Хранит все зарегистрированные строки статистики  
**Структура:** Массив объектов строк с полями `name`, `text`, `validation`, `iteration`, `data` и т.д.

### `mod.timer`
**Тип:** Число  
**Назначение:** Время начала миссии (Unix timestamp)  
**Использование:** Вычисление длительности миссии

### `mod.mission_name`
**Тип:** Строка  
**Назначение:** Название текущей миссии

### `mod.mission_circumstance`
**Тип:** Строка  
**Назначение:** Обстоятельства миссии

### `mod.mission_challenge`
**Тип:** Строка  
**Назначение:** Вызов миссии

### `mod.victory_defeat`
**Тип:** Строка  
**Назначение:** Результат миссии (победа/поражение)

### `mod.tactical_overview`
**Тип:** Булево  
**Назначение:** Флаг отображения scoreboard в тактическом обзоре (HUD)  
**Источник:** Настройка `tactical_overview`

### `mod.hud_active`
**Тип:** Булево  
**Назначение:** Флаг активности HUD тактического обзора  
**Использование:** Определение, нужно ли обновлять виджеты в HUD

### `mod._widget_timers`
**Тип:** Таблица  
**Назначение:** Таймеры для анимации появления виджетов  
**Структура:** `{[widget_name] = timer_value}`

### `mod._widget_times`
**Тип:** Таблица  
**Назначение:** Времена задержки для анимации виджетов  
**Структура:** `{[widget_name] = delay_time}`

### `mod._wait_timer`
**Тип:** Число  
**Назначение:** Общий таймер ожидания для анимации  
**Использование:** Контроль последовательности появления виджетов

---

## Зависимости

- **DMF** - Darktide Mod Framework (обязательно)
- **Managers.ui** - Менеджер UI системы игры
- **Managers.player** - Менеджер игроков
- **Managers.package** - Менеджер пакетов ресурсов
- **CLASS** - Классы игры для хуков

---

## Примеры использования

### Добавление собственной статистики

```lua
-- В другом моде
local my_mod = get_mod("my_mod")

-- Обновление статистики
my_mod:update_stat("my_custom_stat", account_id, 100)
```

### Программное открытие scoreboard

```lua
mod:show_scoreboard_view({end_view = false})
```

### Очистка данных

```lua
mod:clear()
```
