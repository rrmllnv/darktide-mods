# scoreboard_view.lua - UI View для отображения scoreboard

## Назначение

Основной UI view, который отображает таблицу статистики игроков. Наследуется от `BaseView` и управляет созданием, обновлением и отрисовкой всех виджетов scoreboard.

## Класс ScoreboardView

```lua
local ScoreboardView = class("ScoreboardView", "BaseView")
```

Наследуется от `BaseView` - базового класса для всех UI view в игре.

---

## Инициализация

### `ScoreboardView.init(settings, context)`

**Назначение:** Инициализирует view при создании.

**Параметры:**
- `settings` - Настройки view
- `context` - Контекст, переданный при открытии view

**Что делает:**
1. Сохраняет ссылки на менеджеры:
   - `self._player_manager = Managers.player`
2. Загружает определения, блюпринты и настройки:
   - `self._definitions` - Определения UI элементов
   - `self._blueprints` - Шаблоны виджетов
   - `self._settings` - Настройки размеров и стилей
3. Сохраняет контекст:
   - `self.end_view` - Флаг отображения в конце миссии
   - `self.is_history` - Флаг отображения истории
   - `self.rows` - Строки из контекста (если есть)
   - `self.groups` - Группы из контекста (если есть)
   - `self.loaded_players` - Игроки из контекста (если есть)
   - `self.loaded_rows` - Загруженные строки (из истории или текущие)
4. Инициализирует базовый view через `ScoreboardView.super.init()`
5. Устанавливает флаги:
   - `self._pass_draw = true` - Разрешает отрисовку
   - `self._pass_input = true` - Разрешает ввод
6. Инициализирует таймеры анимации:
   - `mod._widget_timers = {}` - Таймеры для каждого виджета
   - `mod._widget_times = {}` - Времена задержки для каждого виджета
   - `mod._wait_timer = 0` - Общий таймер ожидания

---

## Вход и выход

### `ScoreboardView.on_enter()`

**Назначение:** Вызывается при открытии view.

**Что делает:**
1. Перезагружает определения, блюпринты и настройки (на случай изменений)
2. Сбрасывает таймер ожидания
3. Вызывает `ScoreboardView.super.on_enter()`
4. Получает виджет scoreboard: `self.scoreboard_widget`
5. Устанавливает начальную прозрачность: `alpha_multiplier = 0`
6. Устанавливает позицию в зависимости от контекста:
   - История: `offset = {300, 0, base_z}`
   - Не конец миссии: `offset = {0, 0, base_z}`
   - Конец миссии: `offset = {0, -100, base_z}`
7. Инициализирует время появления виджета: `mod._widget_times["scoreboard"] = 0`
8. Создает виджеты строк через `self:setup_row_widgets()`
9. Если не история, настраивает легенду ввода через `self:_setup_input_legend()`
10. Если конец миссии и включено сохранение, сохраняет scoreboard в историю

---

### `ScoreboardView.on_exit()`

**Назначение:** Вызывается при закрытии view.

**Что делает:**
1. Удаляет легенду ввода через `self:remove_input_legend()`
2. Вызывает `ScoreboardView.super.on_exit()`

---

## Управление виджетами строк

### `ScoreboardView.delete_row_widgets()`

**Назначение:** Удаляет все виджеты строк.

**Что делает:**
1. Проходит по всем виджетам в `self.row_widgets`
2. Удаляет каждый виджет из `self._widgets_by_name`
3. Отменяет регистрацию имени виджета через `_unregister_widget_name()`
4. Очищает массив `self.row_widgets`

**Использование:** Вызывается перед созданием новых виджетов для очистки старых.

---

### `mod.get_scoreboard_groups(loaded_rows)`

**Назначение:** Получает список групп из загруженных строк.

**Параметры:**
- `loaded_rows` - Массив загруженных строк

**Возвращает:**
- `groups` - Массив имен групп
- `group_mods` - Таблица соответствия групп и модов: `{[group] = mod}`

**Что делает:**
1. Создает массив групп, начиная с `"none"`
2. Проходит по всем строкам
3. Если у строки есть `group` и его еще нет в списке, добавляет его
4. Сохраняет мод для каждой группы

**Использование:** Определение групп для отображения и создания строк с очками групп.

---

### `mod.get_rows_in_groups(loaded_rows)`

**Назначение:** Организует строки по группам и добавляет строки с очками.

**Параметры:**
- `loaded_rows` - Массив загруженных строк

**Возвращает:** Массив групп, каждая группа - массив строк

**Что делает:**
1. Создает первую группу с заголовком (`name = "header"`)
2. Получает список групп через `get_scoreboard_groups()`
3. Для каждой группы:
   - Создает массив строк группы
   - Проходит по всем строкам
   - Проверяет видимость строки через `setting`:
     - Если `setting` содержит `" = "`, `" < "` или `" > "`, парсит условие
     - Проверяет условие и добавляет строку только если оно выполнено
   - Если группа не пустая и включена генерация очков, добавляет строку с очками группы
4. Если `generate_scores == 1`, добавляет финальную строку с общими очками
5. Если `generate_scores == 2`, удаляет последнюю строку с очками группы
6. Добавляет строки без группы в первую группу

**Использование:** Организация строк для отображения в правильном порядке.

---

### `mod.update_row_values(this_row, sorted_rows, loaded_players)`

**Назначение:** Обновляет значения строки для всех игроков и вычисляет очки.

**Параметры:**
- `this_row` - Объект строки для обновления
- `sorted_rows` - Отсортированные строки по группам
- `loaded_players` - Массив игроков (опционально)

**Что делает:**
1. Если строка - заголовок, пропускает обновление
2. Для каждого игрока (до 4):
   - Если у строки есть `summary`, собирает все дочерние строки
   - Вычисляет очки:
     - Если строка с очками (`score = true`): использует `validation:score()` для каждой дочерней строки
     - Иначе: берет `score` из данных строки
   - Суммирует очки из всех дочерних строк
   - Сохраняет очки в `this_row.data[account_id].score`
3. Если строка требует нормализации (`score = true` или `normalize = true`), нормализует значения
4. Определяет лучших/худших игроков через `validation.is_best()` и `validation.is_worst()`

**Использование:** Вызывается перед созданием виджета строки для вычисления всех значений.

---

### `mod.create_row_widget(...)`

**Назначение:** Создает виджет для одной строки статистики.

**Параметры:**
- `index` - Индекс строки
- `current_offset` - Текущее вертикальное смещение
- `visible_rows` - Количество видимых строк (для чередования фона)
- `this_row` - Объект строки
- `sorted_rows` - Отсортированные строки
- `groups` - Группы локализации
- `widgets_by_name` - Таблица виджетов по именам
- `loaded_players` - Массив игроков
- `is_history` - Флаг истории
- `end_view` - Флаг конца миссии
- `_obj` - Объект view
- `_create_widget_callback` - Имя функции создания виджета
- `ui_renderer` - Рендерер UI

**Возвращает:**
- `widget` - Созданный виджет
- `row_height` - Высота строки

**Что делает:**

1. **Подготовка шаблона:**
   - Клонирует шаблон `scoreboard_row` из блюпринтов
   - Определяет размеры и стили в зависимости от типа строки:
     - Заголовок: высота 30, шрифт 20
     - Большая строка (`big = true`): высота 35, шрифт 30
     - Строка с очками (`score = true`): высота 36, шрифт 24
     - Обычная: высота 18, шрифт 16

2. **Обработка родительских строк:**
   - Если у строки есть `parent`, получает виджет родителя
   - Использует позицию и высоту родителя для выравнивания

3. **Заполнение данных игроков:**
   - Для каждого игрока (до 4) инициализирует пустые данные, если их нет

4. **Обработка заголовка:**
   - Если строка - заголовок, заполняет имена игроков
   - Применяет цвет к имени локального игрока
   - Добавляет символ класса перед именем

5. **Локализация названия строки:**
   - Получает локализованный текст через `this_row.mod:localize()`
   - Если есть `setting`, проверяет наличие варианта локализации с значением настройки

6. **Обработка дочерних строк:**
   - Если у строки есть дочерние строки, скрывает значения игроков в родительской строке
   - Распределяет дочерние строки по колонкам игроков

7. **Вычисление значений:**
   - Вызывает `update_row_values()` для вычисления очков
   - Нормализует значения, если требуется
   - Определяет лучших/худших игроков

8. **Форматирование значений:**
   - Для каждого игрока:
     - Если `is_text = true`, использует текстовое значение
     - Если есть `text_data`, использует его
     - Иначе форматирует число:
       - Если `is_time = true`, использует `shorten_time()`
       - Иначе использует `shorten_value()`
   - Применяет цвета:
     - Нулевые значения: скрывает или делает серыми (в зависимости от настройки)
     - Лучшие значения: оранжевый цвет
     - Худшие значения: серый цвет (если включено)

9. **Обработка иконок:**
   - Если у строки есть иконка, устанавливает ее для каждого игрока

10. **Чередование фона:**
    - Для четных видимых строк скрывает фоновые элементы колонок
    - Для нечетных показывает фоновые элементы

11. **Создание виджета:**
    - Создает виджет через `UIWidget.create_definition()`
    - Устанавливает начальную прозрачность: `alpha_multiplier = 0`
    - Устанавливает позицию в зависимости от контекста
    - Сохраняет время появления в `mod._widget_times`

12. **Обработка длинных текстов:**
    - Для заголовка и текстовых значений вызывает `shrink_text()` для уменьшения шрифта, если текст не помещается

**Использование:** Вызывается для каждой строки при создании виджетов.

---

### `mod.shrink_text(text, style, max_width, ui_renderer)`

**Назначение:** Уменьшает размер шрифта, если текст не помещается в ширину.

**Параметры:**
- `text` - Текст для проверки
- `style` - Стиль текста (содержит `font_size`)
- `max_width` - Максимальная ширина
- `ui_renderer` - Рендерер UI

**Что делает:**
1. Получает текущий размер шрифта
2. Вычисляет ширину текста через `UIRenderer.text_size()`
3. Пока ширина больше максимальной, уменьшает размер шрифта на 1
4. Обновляет `style.font_size`

**Использование:** Предотвращение переполнения текста в колонках.

---

### `mod.normalize_values(players, this_row)`

**Назначение:** Нормализует значения строки к среднему значению 100.

**Параметры:**
- `players` - Массив игроков
- `this_row` - Объект строки

**Возвращает:** Клонированная таблица данных с нормализованными значениями

**Что делает:**
1. Клонирует данные строки
2. Вычисляет среднее значение всех игроков через функцию `average()`
3. Если среднее > 100:
   - Умножает все значения на 0.9 до тех пор, пока среднее не станет <= 100
4. Если среднее < 100:
   - Умножает все значения на 1.1 до тех пор, пока среднее не станет >= 100
5. Возвращает нормализованные данные

**Использование:** Приведение значений к единому масштабу для справедливого сравнения.

---

### `mod.get_row_children(parent, row_name, sorted_rows)`

**Назначение:** Находит все дочерние строки родительской строки.

**Параметры:**
- `parent` - Имя родительской строки
- `row_name` - Имя строки для поиска индекса (опционально)
- `sorted_rows` - Отсортированные строки

**Возвращает:**
- `children` - Массив дочерних строк
- `this_index` - Индекс указанной строки среди дочерних (0, если не найдена)

**Что делает:**
1. Проходит по всем группам и строкам
2. Если у строки `parent == parent`, добавляет ее в массив дочерних
3. Если `row.name == row_name`, сохраняет индекс

**Использование:** Определение дочерних строк для правильного отображения и распределения по колонкам.

---

### `mod.setup_row_widgets(...)`

**Назначение:** Создает все виджеты строк для отображения.

**Параметры:**
- `loaded_rows` - Загруженные строки
- `groups` - Группы локализации
- `row_widgets` - Массив виджетов (будет заполнен)
- `widgets_by_name` - Таблица виджетов по именам (будет заполнена)
- `loaded_players` - Массив игроков
- `is_history` - Флаг истории
- `end_view` - Флаг конца миссии
- `_obj` - Объект view
- `_create_widget_callback` - Имя функции создания виджета
- `ui_renderer` - Рендерер UI

**Возвращает:**
- `sorted_rows` - Отсортированные строки по группам
- `current_offset` - Общая высота всех строк

**Что делает:**
1. Получает отсортированные строки через `get_rows_in_groups()`
2. Инициализирует переменные:
   - `current_offset = 0` - Текущее вертикальное смещение
   - `visible_rows = 0` - Счетчик видимых строк
3. Проходит по всем группам и строкам:
   - Если строка видима (`visible ~= false`):
     - Если строка не дочерняя, увеличивает счетчик видимых строк
     - Создает виджет через `create_row_widget()`
     - Добавляет виджет в массивы
     - Если строка не дочерняя, увеличивает `current_offset` на высоту строки
4. Возвращает отсортированные строки и общую высоту

**Использование:** Создание всех виджетов при открытии view или обновлении данных.

---

### `mod.adjust_size(total_height, scoreboard_widget, scenegraph, row_widgets)`

**Назначение:** Корректирует размер scoreboard и позиции строк в зависимости от общей высоты.

**Параметры:**
- `total_height` - Общая высота всех строк
- `scoreboard_widget` - Виджет scoreboard
- `scenegraph` - Сценграф UI
- `row_widgets` - Массив виджетов строк

**Что делает:**
1. Вычисляет высоту scoreboard: `height = total_height + 75`
2. Ограничивает высоту максимальным значением из настройки `scoreboard_panel_height`
3. Обновляет размеры всех слоев виджета scoreboard:
   - `style_id_1` (тень): `height - 3`
   - `style_id_2` (внутренняя тень): `height - 28`
   - `style_id_3` (фон): `height - 3`
   - `style_id_4` (верхняя рамка): `-height / 2`
   - `style_id_5` (нижняя рамка): `height / 2 - 50`
4. Обновляет размер в сценграфе: `scenegraph.scoreboard.size[2] = height`
5. Вычисляет точку разрыва: `break_point = height - 175 + offset`
6. Для строк, которые выходят за пределы, сдвигает текст вправо для предотвращения перекрытия

**Использование:** Адаптация размера scoreboard под количество строк.

---

### `ScoreboardView.setup_row_widgets()`

**Назначение:** Обертка для создания виджетов строк с сохранением результатов.

**Что делает:**
1. Удаляет старые виджеты через `delete_row_widgets()`
2. Вызывает `mod:setup_row_widgets()` с параметрами view
3. Сохраняет отсортированные строки в `self.sorted_rows`
4. Корректирует размер через `mod:adjust_size()`

---

## Анимация

### `mod.animate_rows(dt, widgets_by_name)`

**Назначение:** Анимирует появление виджетов строк с задержкой.

**Параметры:**
- `dt` - Время кадра
- `widgets_by_name` - Таблица виджетов по именам

**Что делает:**
1. Увеличивает общий таймер ожидания: `mod._wait_timer += dt`
2. Для каждого виджета:
   - Если виджет невидим (`alpha_multiplier == 0`) и таймер еще не запущен:
     - Если время ожидания >= времени появления виджета, запускает таймер
   - Если таймер запущен и > 0:
     - Вычисляет процент завершения: `percentage = timer / fade_length`
     - Устанавливает прозрачность: `alpha_multiplier = 1 - percentage`
     - Уменьшает таймер на `dt`
   - Если таймер <= 0:
     - Устанавливает полную прозрачность: `alpha_multiplier = 1`
     - Удаляет таймер

**Использование:** Плавное появление строк сверху вниз при открытии scoreboard.

---

### `ScoreboardView.animate_rows(dt)`

**Назначение:** Обертка для анимации виджетов view.

**Что делает:**
- Вызывает `mod:animate_rows()` с виджетами view

---

## Управление позицией

### `ScoreboardView.update_scoreboard_offset()`

**Назначение:** Обновляет смещение всех стилей виджетов на основе `scoreboard_offset`.

**Что делает:**
1. Проходит по всем виджетам в `self._widgets_by_name`
2. Для каждого стиля каждого виджета:
   - Сохраняет оригинальное смещение в `original_offset` (если еще не сохранено)
   - Вычисляет новое смещение: `x = original_offset[1] + scoreboard_offset`
   - Обновляет `style.offset`

**Использование:** Сдвиг всего scoreboard влево/вправо при анимации.

---

### `ScoreboardView.update_scoreboard(dt)`

**Назначение:** Обновляет анимацию движения scoreboard.

**Параметры:**
- `dt` - Время кадра

**Что делает:**
1. Если таймер движения активен:
   - Вычисляет процент завершения: `percentage = timer / 0.75`
   - Применяет easing функцию: `t_ease = math.ease_sine(percentage)`
   - Вычисляет пройденное расстояние: `done = lerp(0, range, t_ease)`
   - Обновляет `scoreboard_offset` в зависимости от направления движения
   - Обновляет смещения через `update_scoreboard_offset()`
   - Уменьшает таймер на `dt`
2. Если таймер <= 0:
   - Завершает движение
   - Вызывает callback, если указан

**Использование:** Плавное движение scoreboard при открытии/закрытии карточек игроков.

---

### `ScoreboardView.move_scoreboard(from_offset_x, to_offset_x, callback)`

**Назначение:** Запускает анимацию движения scoreboard.

**Параметры:**
- `from_offset_x` - Начальное смещение по X
- `to_offset_x` - Конечное смещение по X
- `callback` - Функция, вызываемая после завершения (опционально)

**Что делает:**
1. Устанавливает таймер движения: `0.75` секунды
2. Сохраняет начальное и конечное смещение
3. Сохраняет callback

**Использование:** Вызывается из хуков `EndPlayerView` для освобождения места для карточек.

---

## Обновление и отрисовка

### `ScoreboardView.update(dt, t, input_service, view_data)`

**Назначение:** Обновляет view каждый кадр.

**Параметры:**
- `dt` - Время кадра
- `t` - Текущее время
- `input_service` - Сервис ввода
- `view_data` - Данные view

**Что делает:**
1. Обрабатывает тултипы (скрывает, если не наведен курсор)
2. Обновляет анимацию движения scoreboard через `update_scoreboard()`
3. Вызывает `ScoreboardView.super.update()` для базового обновления

---

### `ScoreboardView.draw(dt, t, input_service, layer)`

**Назначение:** Отрисовывает view.

**Параметры:**
- `dt` - Время кадра
- `t` - Текущее время
- `input_service` - Сервис ввода
- `layer` - Слой отрисовки

**Что делает:**
1. Отрисовывает элементы через `_draw_elements()`
2. Отрисовывает виджеты через `_draw_widgets()`

---

### `ScoreboardView._draw_widgets(dt, input_service)`

**Назначение:** Отрисовывает все виджеты scoreboard.

**Что делает:**
1. Начинает проход отрисовки через `UIRenderer.begin_pass()`
2. Обновляет анимацию строк через `animate_rows()`
3. Отрисовывает каждый виджет через `UIWidget.draw()`
4. Завершает проход через `UIRenderer.end_pass()`

---

## Легенда ввода

### `ScoreboardView._setup_input_legend()`

**Назначение:** Настраивает легенду ввода (подсказки по клавишам).

**Что делает:**
1. Создает элемент легенды через `_add_element(ViewElementInputLegend)`
2. Проходит по определениям легенды из `self._definitions.legend_inputs`
3. Добавляет каждую запись в легенду с callback'ами

**Использование:** Отображение подсказок по клавишам (например, "Сохранить").

---

### `ScoreboardView.remove_input_legend()`

**Назначение:** Удаляет легенду ввода.

**Что делает:**
- Удаляет элемент легенды через `_remove_element()`

---

## Сохранение

### `ScoreboardView.cb_on_save_pressed()`

**Назначение:** Callback для кнопки сохранения.

**Что делает:**
1. Удаляет легенду ввода
2. Сохраняет scoreboard в историю через `mod:save_scoreboard_history_entry()`

**Использование:** Привязывается к горячей клавише для сохранения результатов.

---

## Вспомогательные функции

### `average(data, players)`

**Назначение:** Вычисляет среднее значение очков всех игроков.

**Параметры:**
- `data` - Таблица данных: `{[account_id] = {score = value}}`
- `players` - Массив игроков

**Возвращает:** Среднее значение

**Что делает:**
1. Проходит по всем игрокам (до 4)
2. Суммирует значения `score`
3. Делит на количество игроков

**Использование:** Вычисление среднего для нормализации значений.

---

## Переменные view

### `self._player_manager`
Менеджер игроков.

### `self._definitions`
Определения UI элементов (scenegraph, виджеты, легенда).

### `self._blueprints`
Шаблоны виджетов для создания строк.

### `self._settings`
Настройки размеров и стилей.

### `self.end_view`
Флаг отображения в конце миссии.

### `self.is_history`
Флаг отображения истории.

### `self.rows`
Строки из контекста (для истории).

### `self.groups`
Группы локализации из контекста.

### `self.loaded_players`
Игроки из контекста (для истории).

### `self.loaded_rows`
Загруженные строки (из истории или текущие).

### `self.scoreboard_widget`
Виджет основного scoreboard (фон, рамки).

### `self.row_widgets`
Массив виджетов строк.

### `self.sorted_rows`
Отсортированные строки по группам.

### `self._input_legend_element`
Элемент легенды ввода.

### `self.scoreboard_offset`
Текущее смещение scoreboard по X (для анимации).

### `self.scoreboard_move_timer`
Таймер анимации движения.

### `self.scoreboard_move_from_offset`
Начальное смещение для анимации.

### `self.scoreboard_move_to_offset`
Конечное смещение для анимации.

### `self.scoreboard_move_callback`
Callback после завершения анимации движения.

---

## Зависимости

- `BaseView` - Базовый класс view
- `UIWidget` - Класс виджетов
- `UIRenderer` - Рендерер UI
- `TextUtilities` - Утилиты для работы с текстом
- `ViewElementInputLegend` - Элемент легенды ввода
- `ScoreboardViewDefinitions` - Определения UI
- `ScoreboardViewSettings` - Настройки UI
- `ScoreboardViewBlueprints` - Шаблоны виджетов

---

## Примеры использования

### Программное открытие view

```lua
mod:show_scoreboard_view({end_view = false})
```

### Создание собственной строки в view

```lua
local widget, height = mod:create_row_widget(
    index, offset, visible_rows, row,
    sorted_rows, groups, widgets_by_name,
    players, false, false, self, "_create_widget", ui_renderer
)
```

### Анимация появления

```lua
mod:animate_rows(dt, self._widgets_by_name)
```
