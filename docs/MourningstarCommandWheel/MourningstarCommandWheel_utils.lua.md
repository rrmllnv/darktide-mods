# MourningstarCommandWheel_utils.lua - Документация

## Описание файла

Файл утилит и вспомогательных функций для мода Mourningstar Command Wheel. Содержит общие функции, используемые в различных частях мода для проверки состояний игры, локализации текста, активации действий и работы с устройствами ввода.

## Структура файла

Файл возвращает таблицу с экспортируемыми функциями и константами:
- `is_in_valid_lvl` - проверка нахождения в допустимой локации
- `is_in_psychanium` - проверка нахождения в псайкинариуме
- `localize_text` - локализация текста
- `activate_option` - активация действия/вью из опции
- `find_device_for_key` - поиск устройства ввода для клавиши
- `apply_style_offset` - применение смещения к стилю
- `apply_style_color` - применение цвета к стилю
- `valid_lvls` - таблица допустимых локаций

---

## Константы

### `valid_lvls`

Таблица допустимых локаций, где мод активен.

**Тип:** `table`  
**Значения:**
- `shooting_range = true` - тир
- `hub = true` - основной хаб
- `training_grounds = true` - псайкинариум

**Использование:** Используется функцией `is_in_valid_lvl()` для проверки текущей локации.

---

## Функции

### `is_in_valid_lvl()`

Проверяет, находится ли игрок в допустимой локации для работы мода.

**Параметры:** Нет

**Возвращает:** `boolean` - `true` если игрок в допустимой локации, `false` иначе

**Логика:**
1. Проверяет наличие `Managers.state.game_mode`
2. Получает имя текущего игрового режима через `game_mode_name()`
3. Проверяет наличие режима в таблице `valid_lvls`
4. Возвращает результат проверки

**Использование:** Используется в `MourningstarCommandWheel.lua` и `HudElementCommandWheel.lua` для проверки возможности активации колеса.

---

### `is_in_psychanium()`

Проверяет, находится ли игрок в псайкинариуме (training grounds или shooting range).

**Параметры:** Нет

**Возвращает:** `boolean` - `true` если игрок в псайкинариуме, `false` иначе

**Логика:**
1. Проверяет наличие `Managers.state.game_mode`
2. Получает имя текущего игрового режима
3. Проверяет, является ли режим `"training_grounds"` или `"shooting_range"`
4. Если не найдено через game_mode, проверяет активность вью `"training_grounds_view"` через `Managers.ui`
5. Возвращает результат проверки

**Использование:** Используется в `HudElementCommandWheel.lua` для динамической замены кнопки `training_grounds` на `exit_psychanium`.

---

### `localize_text(label_key)`

Локализует текст по ключу локализации.

**Параметры:**
- `label_key` (`string` или `nil`) - ключ локализации

**Возвращает:** `string` - локализованный текст или пустая строка

**Логика:**
1. Если `label_key` отсутствует, возвращает пустую строку
2. Если ключ начинается с `"loc_"`, использует `Localize()` (встроенная локализация игры)
3. Иначе использует `mod:localize()` (локализация мода)
4. Возвращает локализованный текст

**Использование:** Используется в `HudElementCommandWheel.lua` для локализации названий кнопок и текстов.

---

### `activate_option(option)`

Активирует действие или открывает вью из опции кнопки.

**Параметры:**
- `option` (`table` или `nil`) - опция кнопки с полями `action` или `view`

**Возвращает:** `boolean` - `true` если активация успешна, `false` иначе

**Логика:**
1. Если `option` отсутствует, возвращает `false`
2. Выполняет действие в защищенном режиме через `pcall()`
3. Если `option.action == "change_character"`, вызывает `mod:change_character()`
4. Если `option.action == "exit_psychanium"`, вызывает `Managers.state.game_mode:complete_game_mode()`
5. Если `option.view` задан, вызывает `mod:activate_hub_view(option.view)`
6. При ошибке логирует её и возвращает `false`
7. При успехе возвращает `true`

**Использование:** Используется в `HudElementCommandWheel.lua` для обработки кликов по кнопкам колеса.

---

### `find_device_for_key(key, supported_devices)`

Находит устройство ввода и индекс кнопки для заданной клавиши.

**Параметры:**
- `key` (`string` или `nil`) - идентификатор клавиши
- `supported_devices` (`table` или `nil`) - массив поддерживаемых типов устройств (например, `{"keyboard", "mouse"}`)

**Возвращает:** `table` или `nil` - таблица с полями `device` и `index`, или `nil` если устройство не найдено

**Логика:**
1. Если параметры отсутствуют, возвращает `nil`
2. Перебирает типы устройств из `supported_devices`
3. Для каждого типа находит активное устройство через `Managers.input:_find_active_device()`
4. Получает индекс кнопки через `device:button_index(key)`
5. Если индекс найден, возвращает таблицу с устройством и индексом
6. Если устройство не найдено, возвращает `nil`

**Использование:** Используется в `MourningstarCommandWheel.lua` для настройки обработки клавиш (main key, enablers, disablers).

---

### `apply_style_offset(style, offset_x, offset_y)`

Применяет смещение к стилю виджета.

**Параметры:**
- `style` (`table` или `nil`) - объект стиля виджета
- `offset_x` (`number`) - смещение по оси X
- `offset_y` (`number`) - смещение по оси Y

**Возвращает:** Нет

**Логика:**
1. Если `style` отсутствует, ничего не делает
2. Устанавливает `style.offset[1] = offset_x`
3. Устанавливает `style.offset[2] = offset_y`

**Использование:** Используется в `HudElementCommandWheel.lua` для визуальной обратной связи при перетаскивании кнопок.

---

### `apply_style_color(style, color)`

Применяет цвет к стилю виджета.

**Параметры:**
- `style` (`table` или `nil`) - объект стиля виджета
- `color` (`table` или `nil`) - массив цвета в формате `{r, g, b, a}`

**Возвращает:** Нет

**Логика:**
1. Если `style` или `color` отсутствуют, ничего не делает
2. Устанавливает компоненты цвета:
   - `style.color[1] = color[1]` (red)
   - `style.color[2] = color[2]` (green)
   - `style.color[3] = color[3]` (blue)
   - `style.color[4] = color[4]` (alpha)

**Использование:** Используется в `HudElementCommandWheel.lua` для изменения цветов стилей при перетаскивании кнопок.

---

## Использование

Файл используется в следующих местах:

- **MourningstarCommandWheel.lua:**
  - `is_in_valid_lvl()` - проверка допустимости локации
  - `find_device_for_key()` - настройка обработки клавиш

- **HudElementCommandWheel.lua:**
  - `is_in_valid_lvl()` - проверка допустимости локации
  - `is_in_psychanium()` - проверка нахождения в псайкинариуме
  - `localize_text()` - локализация текстов кнопок
  - `activate_option()` - активация действий при клике
  - `apply_style_offset()` - визуальная обратная связь при перетаскивании
  - `apply_style_color()` - изменение цветов при перетаскивании

## Примечания

- Все функции защищены от ошибок через проверки на `nil`
- Функции локализации и активации используют защищенный режим выполнения (`pcall`)
- Функции работы со стилями безопасно обрабатывают отсутствие параметров
- Таблица `valid_lvls` экспортируется для возможного использования в других модулях

