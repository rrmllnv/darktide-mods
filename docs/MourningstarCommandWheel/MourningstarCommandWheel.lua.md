# MourningstarCommandWheel.lua - Документация

## Описание файла

Основной файл мода, содержащий логику регистрации, обработки ввода, активации views и управления HUD элементом.

## Зависимости

- `InputUtils` - утилиты для работы с вводом
- Модули мода: `command_wheel_settings`, `command_wheel_definitions`, `HudElementCommandWheel`

## Глобальные переменные

### `valid_lvls`
Таблица с допустимыми игровыми режимами, где работает мод:
- `shooting_range` - тир
- `hub` - основной хаб
- `training_grounds` - псайкинариум

### `hud_elements`
Массив с определением HUD элемента для регистрации в системе HUD.

## Функции

### `is_in_valid_lvl()`
Проверяет, находимся ли мы в допустимой локации для работы мода.

**Возвращает:**
- `boolean` - `true` если находимся в допустимой локации, иначе `false`

**Логика:**
- Проверяет `Managers.state.game_mode:game_mode_name()` на наличие в `valid_lvls`

---

### `can_activate_view(ui_manager, view)`
Проверяет, можно ли активировать указанный view.

**Параметры:**
- `ui_manager` - менеджер UI
- `view` - имя view для активации

**Возвращает:**
- `boolean` - `true` если view можно активировать, иначе `false`

**Логика:**
1. Проверяет существование `ui_manager` и `view`
2. Проверяет, что view существует в системе Views
3. Проверяет доступность view через `ui_manager:view_is_available()`
4. Проверяет, что мы в допустимой локации
5. Проверяет, что чат не использует ввод
6. Проверяет, что view не открыт

---

### `mod:activate_hub_view(view)`
Активирует указанный hub view.

**Параметры:**
- `view` - имя view для активации

**Возвращает:**
- `boolean` - `true` если view успешно открыт, иначе `false`

**Логика:**
1. Проверяет существование `view`
2. Проверяет доступность через `can_activate_view()`
3. Открывает view с контекстом `hub_interaction = true`
4. Обрабатывает ошибки через `pcall`

---

### `mod:change_character()`
Выполняет выход в главное меню (смена персонажа).

**Возвращает:**
- `boolean` - `true` если операция успешна, иначе `false`

**Логика:**
1. Проверяет, что мы в допустимой локации
2. Вызывает `Managers.multiplayer_session:leave("exit_to_main_menu")`
3. Обрабатывает ошибки через `pcall`

---

### `mod:get_command_wheel_element()`
Возвращает текущий экземпляр HUD элемента колеса команд.

**Возвращает:**
- `HudElementCommandWheel` или `nil` - экземпляр элемента или `nil` если не инициализирован

---

### `mod:_is_command_wheel_key_pressed()`
Проверяет, нажата ли клавиша открытия колеса команд.

**Возвращает:**
- `boolean` - `true` если клавиша нажата, иначе `false`

**Логика:**
1. Если `_command_wheel_eval_func` не создана, создает её:
   - Получает настройки keybind из `mod:get("open_command_wheel_key")`
   - Конвертирует через DMF `local_keys_to_keywatch_result()`
   - Находит device и index для основной клавиши
   - Создает функции проверки для enablers и disablers
   - Сохраняет функцию проверки в `_command_wheel_eval_func`
2. Вызывает `_command_wheel_eval_func()` для проверки состояния клавиши

**Особенности:**
- Поддерживает enablers (клавиши, которые должны быть нажаты)
- Поддерживает disablers (клавиши, которые не должны быть нажаты)
- Кэширует функцию проверки для производительности

---

### `mod:command_wheel_held()`
Вызывается при удержании клавиши открытия колеса. Сбрасывает кэш функции проверки клавиши.

**Логика:**
- Устанавливает `mod._command_wheel_eval_func = nil` для пересоздания функции при следующей проверке

---

### `mod:close_command_wheel()`
Закрывает колесо команд. Сбрасывает кэш функции проверки клавиши.

**Логика:**
- Устанавливает `mod._command_wheel_eval_func = nil`

---

### `mod.on_setting_changed(setting_id)`
Обработчик изменения настроек мода.

**Параметры:**
- `setting_id` - идентификатор измененной настройки

**Логика:**
- Если изменена настройка `open_command_wheel_key`, сбрасывает кэш функции проверки клавиши

## Хуки

### `UIHud.init`
Хук для регистрации HUD элемента в системе HUD.

**Логика:**
- Добавляет `HudElementCommandWheel` в список элементов, если его там еще нет
- Использует `visibility_groups = {"alive", "dead"}` для отображения в любом состоянии

---

### `HudElementCommandWheel.init`
Хук для сохранения ссылки на экземпляр HUD элемента.

**Логика:**
- Сохраняет экземпляр в `mod._command_wheel_element` для доступа из других частей мода

## Внутренние переменные

### `mod._command_wheel_element`
Ссылка на текущий экземпляр `HudElementCommandWheel` или `nil`.

### `mod._command_wheel_eval_func`
Кэшированная функция для проверки состояния клавиши открытия колеса или `nil`.

