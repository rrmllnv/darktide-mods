# scoreboard_hud.lua - Интеграция с HUD (тактический обзор)

## Назначение

Файл интегрирует scoreboard с HUD тактического обзора, позволяя отображать статистику во время игры.

## Основные компоненты

### Хук `HudElementPlayerOnboarding`

**Назначение:** Добавляет тактический обзор в список элементов HUD для Meat Grinder.

**Что делает:**
1. Проверяет, не добавлен ли уже `HudElementTacticalOverlay` другим модом
2. Если нет, добавляет его в массив элементов HUD:
   - `package` - Пакет тактического обзора
   - `class_name` - `"HudElementTacticalOverlay"`
   - `filename` - Путь к файлу класса
   - `visibility_groups` - Группы видимости

**Использование:** Обеспечивает доступность тактического обзора в тренировочной зоне.

---

### Хук `HudElementTacticalOverlayDefinitions`

**Назначение:** Добавляет элементы scoreboard в определения тактического обзора.

**Что делает:**
1. Добавляет в `scenegraph_definition`:
   - **`scoreboard`** - Основной элемент scoreboard
     - Размер: из `ScoreboardViewSettings.scoreboard_size`
     - Позиция: `{base_x, 0, base_z}` (base_x = 135)
   - **`scoreboard_rows`** - Контейнер для строк
     - Родитель: `"scoreboard"`
     - Размер: ширина scoreboard, высота = высота scoreboard - 100
     - Позиция: `{base_x, 40, base_z - 1}`

2. Добавляет в `widget_definitions`:
   - **`scoreboard`** - Виджет фона scoreboard с несколькими слоями:
     - Слой 1: Тень (`dropshadow_heavy`)
     - Слой 2: Внутренняя тень (`inner_shadow_medium`)
     - Слой 3: Фон (`terminal_basic`)
     - Слой 4: Верхняя рамка (`details_upper`)
     - Слой 5: Нижняя рамка (`details_lower_basic`)

**Использование:** Определяет структуру UI для отображения scoreboard в HUD.

---

### Хук `HudElementTacticalOverlay._draw_widgets`

**Назначение:** Отрисовывает виджеты scoreboard в тактическом обзоре.

**Что делает:**
1. Вызывает оригинальную функцию отрисовки
2. Получает виджет scoreboard из `_widgets_by_name`
3. Устанавливает прозрачность в зависимости от `mod.tactical_overview`:
   - Если включено: использует `_alpha_multiplier` тактического обзора
   - Если выключено: `alpha_multiplier = 0` (невидим)
4. Отрисовывает виджеты строк, если они есть:
   - Устанавливает прозрачность аналогично
   - Отрисовывает каждый виджет через `UIWidget.draw()`

**Использование:** Отображение scoreboard в HUD с учетом настроек видимости.

---

### Хук `HudElementTacticalOverlay.update`

**Назначение:** Обновляет виджеты scoreboard в тактическом обзоре.

**Что делает:**
1. Вызывает оригинальную функцию обновления
2. Инициализирует `self.row_widgets = {}`, если еще не инициализирован
3. Получает виджет scoreboard
4. Определяет, нужно ли удалить строки:
   - Если тактический обзор активен, а HUD не активен → удалить
   - Если тактический обзор не активен, а HUD активен → удалить
5. Если нужно удалить:
   - Удаляет все виджеты строк из `_widgets_by_name`
   - Очищает `self.row_widgets`
6. Если тактический обзор активен и HUD не активен:
   - Сбрасывает таймеры анимации
   - Получает группы строк
   - Получает игроков
   - Создает виджеты строк через `mod:setup_row_widgets()`
   - Корректирует размер scoreboard через `mod:adjust_size()`
7. Проверяет, находится ли игрок в хабе:
   - Если в хабе или прологе, скрывает виджеты
   - Иначе показывает виджеты
8. Сохраняет состояние активности HUD в `mod.hud_active`

**Использование:** Управление жизненным циклом виджетов scoreboard в HUD.

---

## Вспомогательные функции

### `_is_in_hub()`

**Назначение:** Проверяет, находится ли игрок в хабе.

**Возвращает:** `true`, если `game_mode_name == "hub"`

---

### `_is_in_prologue_hub()`

**Назначение:** Проверяет, находится ли игрок в прологе.

**Возвращает:** `true`, если `game_mode_name == "prologue_hub"`

---

## Переменные

### `mod.tactical_overview`
**Тип:** Булево  
**Назначение:** Флаг отображения scoreboard в тактическом обзоре  
**Источник:** Настройка `tactical_overview`

### `mod.hud_active`
**Тип:** Булево  
**Назначение:** Флаг активности HUD тактического обзора  
**Устанавливается:** В хуке `HudElementTacticalOverlay.update`

### `base_z`
**Тип:** Число  
**Значение:** 100  
**Назначение:** Базовый Z-индекс для элементов scoreboard

### `base_x`
**Тип:** Число  
**Значение:** 135  
**Назначение:** Базовое смещение по X для элементов scoreboard

---

## Зависимости

- `HudElementTacticalOverlay` - Класс тактического обзора
- `ScoreboardViewSettings` - Настройки размеров scoreboard
- `UIWidget` - Класс виджетов
- `UIRenderer` - Рендерер UI

---

## Логика работы

1. **Инициализация:**
   - При загрузке мода добавляется тактический обзор в HUD
   - Добавляются определения элементов scoreboard

2. **Обновление:**
   - Каждый кадр проверяется состояние тактического обзора
   - Если обзор активен и HUD не активен, создаются виджеты строк
   - Видимость контролируется настройкой `tactical_overview`

3. **Отрисовка:**
   - Виджеты отрисовываются с учетом прозрачности тактического обзора
   - В хабе виджеты скрываются

---

## Примеры использования

### Проверка активности HUD

```lua
if mod.hud_active then
    -- HUD активен
end
```

### Проверка настройки тактического обзора

```lua
if mod.tactical_overview then
    -- Тактический обзор включен
end
```
